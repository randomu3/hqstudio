<Window x:Class="HQStudio.Views.Dialogs.EditOrderDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð°" 
        Height="650" Width="550"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="NoResize"
        KeyDown="Window_KeyDown"
        FocusManager.FocusedElement="{Binding ElementName=ClientCombo}">

    <Border Background="{DynamicResource BgDialogBrush}" CornerRadius="16" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="50"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Background="{DynamicResource BgDialogHeaderBrush}" CornerRadius="16,16,0,0" 
                    MouseLeftButtonDown="Header_MouseLeftButtonDown">
                <Grid>
                    <TextBlock x:Name="TitleText" Text="ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·" FontSize="15" FontWeight="SemiBold" 
                               Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Margin="20,0"/>
                    <Button Content="âœ•" HorizontalAlignment="Right" Click="Close_Click"
                            Background="Transparent" Foreground="#606060" BorderThickness="0"
                            Width="50" Height="50" FontSize="14" Cursor="Hand"/>
                </Grid>
            </Border>

            <!-- Form -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="24,20">
                <StackPanel>
                    <TextBlock Text="ÐšÐ›Ð˜Ð•ÐÐ¢ *" Style="{DynamicResource TextLabel}" Margin="0,0,0,8"/>
                    
                    <!-- Client Search -->
                    <Grid Margin="0,0,0,8">
                        <TextBox x:Name="ClientSearchBox" Style="{DynamicResource InputText}" 
                                 TextChanged="ClientSearch_TextChanged"
                                 GotFocus="ClientSearchBox_GotFocus"
                                 LostFocus="ClientSearchBox_LostFocus"/>
                        <TextBlock x:Name="ClientSearchPlaceholder" Text="ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ð¸Ð»Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ..." 
                                   Foreground="{DynamicResource TextMutedBrush}" 
                                   VerticalAlignment="Center" Margin="16,0" IsHitTestVisible="False"/>
                    </Grid>
                    
                    <!-- Client Search Results Popup -->
                    <Popup x:Name="ClientPopup" PlacementTarget="{Binding ElementName=ClientSearchBox}" 
                           Placement="Bottom" StaysOpen="False" AllowsTransparency="True">
                        <Border Background="{DynamicResource BgCardBrush}" CornerRadius="8" 
                                BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="1"
                                MaxHeight="250" Width="{Binding ActualWidth, ElementName=ClientSearchBox}">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="ClientSearchResults">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border x:Name="ClientItemBorder" Background="Transparent" 
                                                    Padding="12,10" Cursor="Hand"
                                                    MouseLeftButtonDown="ClientItem_Click">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="30"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="ðŸ‘¤" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                                    <StackPanel Grid.Column="1">
                                                        <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="SemiBold"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                        <TextBlock FontSize="12" Foreground="{DynamicResource TextMutedBrush}">
                                                            <Run Text="ðŸ“ž"/>
                                                            <Run Text="{Binding Phone}"/>
                                                            <Run Text=" â€¢ "/>
                                                            <Run Text="{Binding Car}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                            <DataTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="ClientItemBorder" Property="Background" 
                                                            Value="{DynamicResource BgHoverBrush}"/>
                                                </Trigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>
                    </Popup>
                    
                    <!-- Selected Client Display -->
                    <Border x:Name="SelectedClientBorder" Background="{DynamicResource BgHoverBrush}" 
                            CornerRadius="8" Padding="12,10" Margin="0,0,0,16" Visibility="Collapsed">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="30"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="ðŸ‘¤" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock x:Name="SelectedClientName" FontSize="13" FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBlock x:Name="SelectedClientInfo" FontSize="12" 
                                           Foreground="{DynamicResource TextMutedBrush}"/>
                            </StackPanel>
                            <Button Grid.Column="2" Content="âœ•" Width="28" Height="28" 
                                    Background="Transparent" Foreground="#808080" 
                                    BorderThickness="0" Cursor="Hand" FontSize="12"
                                    Click="ClearClient_Click" ToolTip="ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ"/>
                        </Grid>
                    </Border>

                    <TextBlock Text="Ð£Ð¡Ð›Ð£Ð“Ð˜" Style="{DynamicResource TextLabel}" Margin="0,0,0,8"/>
                    
                    <!-- Service Search -->
                    <Grid Margin="0,0,0,8">
                        <TextBox x:Name="ServiceSearchBox" Style="{DynamicResource InputText}" 
                                 TextChanged="ServiceSearch_TextChanged"
                                 GotFocus="ServiceSearchBox_GotFocus"
                                 LostFocus="ServiceSearchBox_LostFocus"/>
                        <TextBlock x:Name="SearchPlaceholder" Text="ðŸ” ÐŸÐ¾Ð¸ÑÐº ÑƒÑÐ»ÑƒÐ³Ð¸..." 
                                   Foreground="{DynamicResource TextMutedBrush}" 
                                   VerticalAlignment="Center" Margin="16,0" IsHitTestVisible="False"/>
                    </Grid>
                    
                    <!-- Service Search Results Popup -->
                    <Popup x:Name="ServicePopup" PlacementTarget="{Binding ElementName=ServiceSearchBox}" 
                           Placement="Bottom" StaysOpen="False" AllowsTransparency="True">
                        <Border Background="{DynamicResource BgCardBrush}" CornerRadius="8" 
                                BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="1"
                                MaxHeight="200" Width="{Binding ActualWidth, ElementName=ServiceSearchBox}">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="ServiceSearchResults">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border x:Name="ItemBorder" Background="Transparent" 
                                                    Padding="12,10" Cursor="Hand"
                                                    MouseLeftButtonDown="ServiceItem_Click">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="30"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Icon}" FontSize="16"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="13" 
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                    <TextBlock Grid.Column="2" FontSize="12" Foreground="{DynamicResource TextMutedBrush}">
                                                        <Run Text="Ð¾Ñ‚"/>
                                                        <Run Text="{Binding PriceFrom, StringFormat={}{0:N0}}"/>
                                                        <Run Text="â‚½"/>
                                                    </TextBlock>
                                                </Grid>
                                            </Border>
                                            <DataTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="ItemBorder" Property="Background" 
                                                            Value="{DynamicResource BgHoverBrush}"/>
                                                </Trigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>
                    </Popup>
                    
                    <!-- Selected Services -->
                    <ItemsControl x:Name="SelectedServicesList" Margin="0,0,0,16">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource BgHoverBrush}" CornerRadius="8" 
                                        Padding="12,8" Margin="0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="26"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Icon}" FontSize="14"/>
                                        <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="13" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="2" FontSize="12" Foreground="#4CAF50" 
                                                   VerticalAlignment="Center" Margin="8,0">
                                            <Run Text="{Binding PriceFrom, StringFormat={}{0:N0}}"/>
                                            <Run Text="â‚½"/>
                                        </TextBlock>
                                        <Button Grid.Column="3" Content="âœ•" Width="24" Height="24" 
                                                Background="Transparent" Foreground="#808080" 
                                                BorderThickness="0" Cursor="Hand" FontSize="10"
                                                Tag="{Binding Id}" Click="RemoveService_Click"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock Text="Ð¡Ð¢ÐÐ¢Ð£Ð¡" Style="{DynamicResource TextLabel}" Margin="0,0,0,8"/>
                    <ComboBox x:Name="StatusCombo" Style="{DynamicResource InputComboBox}" Margin="0,0,0,16"
                              SelectionChanged="StatusCombo_SelectionChanged">
                        <ComboBoxItem Content="ÐÐ¾Ð²Ñ‹Ð¹" IsSelected="True"/>
                        <ComboBoxItem Content="Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ"/>
                        <ComboBoxItem Content="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½"/>
                    </ComboBox>

                    <TextBlock Text="Ð¡Ð£ÐœÐœÐ (â‚½)" Style="{DynamicResource TextLabel}" Margin="0,0,0,8"/>
                    <Grid Margin="0,0,0,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="PriceBox" Grid.Column="0" Style="{DynamicResource InputText}"
                                 PreviewTextInput="PriceBox_PreviewTextInput"
                                 TextChanged="PriceBox_TextChanged"/>
                        <Button Grid.Column="1" Content="ÐÐ²Ñ‚Ð¾" Style="{DynamicResource BtnSecondary}" 
                                Padding="12,10" Margin="8,0,0,0" Click="AutoPrice_Click"
                                ToolTip="Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÑƒÐ¼Ð¼Ñƒ Ð¿Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼ ÑƒÑÐ»ÑƒÐ³Ð°Ð¼"/>
                    </Grid>

                    <TextBlock Text="Ð—ÐÐœÐ•Ð¢ÐšÐ˜" Style="{DynamicResource TextLabel}" Margin="0,0,0,8"/>
                    <TextBox x:Name="NotesBox" Style="{DynamicResource InputText}" 
                             TextWrapping="Wrap" AcceptsReturn="True" Height="80"
                             VerticalContentAlignment="Top"
                             TextChanged="NotesBox_TextChanged"/>
                </StackPanel>
            </ScrollViewer>

            <!-- Buttons -->
            <Border Grid.Row="2" Background="{DynamicResource BgDialogHeaderBrush}" Padding="24,16" CornerRadius="0,0,16,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Button Grid.Column="0" Content="ÐžÑ‚Ð¼ÐµÐ½Ð°" Style="{DynamicResource BtnSecondary}" 
                            Click="Cancel_Click" Margin="0,0,8,0" IsCancel="True"/>
                    <Button Grid.Column="1" Content="Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ" Style="{DynamicResource BtnPrimary}" 
                            Click="Save_Click" Margin="8,0,0,0" IsDefault="True"/>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
