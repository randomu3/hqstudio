name: Release

on:
  push:
    tags:
      - 'v*'

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  API_IMAGE_NAME: ${{ github.repository }}/api
  WEB_IMAGE_NAME: ${{ github.repository }}/web

jobs:
  # ===========================================
  # Run Tests First
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Test API
        run: dotnet test HQStudio.API.Tests/HQStudio.API.Tests.csproj --verbosity normal
      
      - name: Test Web
        working-directory: HQStudio.Web
        run: |
          npm ci --legacy-peer-deps
          npm test

  # ===========================================
  # Build & Push Docker Images
  # ===========================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
      
      - name: Extract metadata for Web
        id: meta-web
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./HQStudio.API
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
      
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./HQStudio.Web
          push: true
          tags: ${{ steps.meta-web.outputs.tags }}
          labels: ${{ steps.meta-web.outputs.labels }}

  # ===========================================
  # Build Desktop Release
  # ===========================================
  build-desktop:
    name: Build Desktop
    runs-on: windows-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Publish Desktop
        run: dotnet publish HQStudio.Desktop/HQStudio.csproj -c Release -r win-x64 --self-contained -o ./publish
      
      - name: Upload Desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: HQStudio-Desktop-${{ github.ref_name }}
          path: ./publish/

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-push, build-desktop]
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Desktop artifact
        uses: actions/download-artifact@v4
        with:
          name: HQStudio-Desktop-${{ github.ref_name }}
          path: ./desktop-release
      
      - name: Create ZIP archive
        run: |
          cd desktop-release
          zip -r ../HQStudio-Desktop-${{ github.ref_name }}.zip .
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## Changes" > CHANGELOG.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> CHANGELOG.md || echo "- Initial release" >> CHANGELOG.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          files: |
            HQStudio-Desktop-${{ github.ref_name }}.zip
          generate_release_notes: true
